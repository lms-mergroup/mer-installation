- name: Install IIS features from XML and reboot if needed
  hosts: iis
  gather_facts: no
  collections:
    - ansible.windows

  vars_files:
    - "{{ customer_data_dir }}/iis-common-vars.yaml"

  tasks:
    - name: Install features from XML with reboot detection
      ansible.windows.win_shell: |
        $features = Import-Clixml -Path "{{ iis_features_xml }}"
        $restartNeeded = $false

        foreach ($feature in $features) {
            Write-Output "Processing feature: $($feature.Name)"
            $result = Add-WindowsFeature $feature.Name
            Write-Output "RestartNeeded value: $($result.RestartNeeded)"
            if ($result.RestartNeeded -eq 'Yes' -or $result.RestartNeeded -eq $true) {
                $restartNeeded = $true
            }
        }

        if ($restartNeeded) {
            Write-Output "REBOOT_REQUIRED"
        }
      register: feature_install

    - name: Debug feature_install stdout lines
      debug:
        var: feature_install.stdout_lines

    - name: Reboot if needed
      ansible.windows.win_reboot:
      when: "'REBOOT_REQUIRED' in feature_install.stdout"
