@App:name("Siddhi_CCTV")
@App:description('Consume events from a Kafka Topic and publish to a different Kafka Topic')


--source for CCTV
@source(type='kafka',
        topic.list='Topic_DA_CCTV',
        partition.no.list='0',
        threading.option='single.thread',
        group.id="group",
              bootstrap.servers='kafka.service.{{datacenter}}.valerian:29092',
        @map(
                        type='json', fail.on.missing.attribute='false', enclosing.element="$",
                        @attributes(
                                CreationDate = "CreationDate",
                                InputId = "InputId",
                                TriggerElementId = "TriggerElementId",
                                TriggerStr = "TriggerStr",
                                TriggerId ="TriggerId",
                                ExternalId="ExternalId",
                                StatusId="StatusId",
                                ExtraData="ExtraData",
                                Severity="Severity",
                                TriggerDescription="TriggerDescription",
                                EventType="EventType",
                                UserId="UserId",
                                InputType="InputType",
                                ServiceStateId="ServiceStateId",
                                Notify="Notify",
                                EventSingleInstanceFlagRaised="EventSingleInstanceFlagRaised",
				AdditionalInfo="AdditionalInfo"
                                )
                        )
                )


define stream SMNGStream_CCTV_AsJSON(
                            CreationDate string,
                            InputId string,
                            TriggerElementId string ,
                            TriggerStr string,
                            TriggerId string,
                            ExternalId string,
                            StatusId string,
                            ExtraData string,
                            Severity string,
                            TriggerDescription string,
                            EventType string,
                            UserId string,
                            InputType string,
                            ServiceStateId string,
                            Notify string,
                            EventSingleInstanceFlagRaised bool,
			    AdditionalInfo string
);

--At the end we need to insert this info into Kafka again
@sink(type='kafka',
      topic='Topic_Events',
bootstrap.servers='kafka.service.{{datacenter}}.valerian:29092',
      partition.no='0',
      @map(type='json'))

define stream SMNGStreamEvents(
                            InputId string,
                            TriggerElementId string,
                            TriggerStr string,
                            TriggerId string,
                            CreationDate string,
                            ExternalId string,
                            StatusId string,
                            ExtraData string,
                            TemplateId string, 
                            UserId string, 
                            SeverityId string,
                            totalVolume int,
                            InputType string,
                            ServiceStateId string,	
                            EventSingleInstanceFlagRaised bool
                            );

--At the end we need to insert this info into Kafka again	
@sink(type='kafka',	
      topic='Topic_Inputs',	
bootstrap.servers='kafka.service.{{datacenter}}.valerian:29092',	
      partition.no='0',	
      @map(type='json'))	
define stream SMNGStreamInputs(	
                            InputId string,	
                            TriggerElementId string,	
                            TriggerStr string,	
                            TriggerId string,	
                            CreationDate string,	
                            ExternalId string,	
                            StatusId string,	
                            ExtraData string,	
                            TemplateId string, 	
                            UserId string, 	
                            SeverityId string,	
                            totalVolume int,	
                            InputType string,	
                            ServiceStateId string,	
                            EventSingleInstanceFlagRaised bool	
                            );	

@sink(type='kafka',
      topic='Topic_Statuses',
bootstrap.servers='kafka.service.{{datacenter}}.valerian:29092',
      partition.no='0',
      @map(type='json'))

define stream SMNGStreamStatuses(
                            InputId string,
                            TriggerElementId string,
                            TriggerStr string,
                            TriggerId string,
                            CreationDate string,
                            ExternalId string,
                            StatusId string,
                            ExtraData string,
                            TemplateId string, 
                            UserId string, 
                            SeverityId string,
                            totalVolume int,
                            InputType string,
                            ServiceStateId string,
                            Notify string,	
                            EventSingleInstanceFlagRaised bool
                            );


--Anyvision Enrichment
@sink(type='kafka',
      topic='Topic_Enrich_In_Anyvision',
bootstrap.servers='kafka.service.{{datacenter}}.valerian:29092',
      partition.no='0',
      @map(type='json'))

define stream SMNGOutputStreamEnrichmentAnyvision(
                            InputId string,
                            CreationDate string,
                            UserId string, 
                            InputType string,
                            AdditionalInfo object
                            );

define stream SMNGStreamEnrichmentAnyvisionToJSON (InputId string, CreationDate string, UserId string, InputType string, AdditionalInfoJsonObj object);

--Findface Enrichment
@sink(type='kafka',
      topic='Topic_Enrich_In_Findface',
bootstrap.servers='kafka.service.{{datacenter}}.valerian:29092',
      partition.no='0',
      @map(type='json'))

define stream SMNGOutputStreamEnrichmentFindface(
                            InputId string,
                            CreationDate string,
                            UserId string, 
                            InputType string,
                            AdditionalInfo object
                            );

define stream SMNGStreamEnrichmentFindfaceToJSON (InputId string, CreationDate string, UserId string, InputType string, AdditionalInfoJsonObj object);


--for each input in Topic_DA_Okazas move it to Topic_Events
@info(name='query_events')
from SMNGStream_CCTV_AsJSON [InputType == 'Event' and (EventSingleInstanceFlagRaised != true and TriggerStr != 'Unknown element arrived')] 
--#window.length(5)
select
    InputId ,
    TriggerElementId  ,
    TriggerStr ,
    TriggerId ,
    CreationDate,
    ExternalId ,
    StatusId ,
    ExtraData ,
    EventType as TemplateId,
    UserId,
    Severity as SeverityId,
    1 as totalVolume ,
    InputType,
    ServiceStateId,
    EventSingleInstanceFlagRaised
insert into SMNGStreamEvents;

--for each input in Topic_DA_CCTV move it to Topic_Inputs	
@info(name='query_inputs')	
from SMNGStream_CCTV_AsJSON [InputType == 'Event' and EventSingleInstanceFlagRaised == true] 	
--#window.length(5)	
select	
    InputId ,	
    TriggerElementId  ,	
    TriggerStr ,	
    TriggerId ,	
    CreationDate,	
    ExternalId ,	
    StatusId ,	
    ExtraData ,	
    EventType as TemplateId,	
    UserId,	
    Severity as SeverityId,	
    1 as totalVolume ,	
    InputType,	
    ServiceStateId,	
    EventSingleInstanceFlagRaised	
insert into SMNGStreamInputs;

--for each input in Topic_DA_CCTV move it to Topic_Statuses
@info(name='query_Statuses')
from SMNGStream_CCTV_AsJSON [InputType == 'Status'] 
--#window.length(5)
select
    InputId ,
    TriggerElementId  ,
    TriggerStr ,
    TriggerId ,
    CreationDate,
    ExternalId ,
    StatusId ,
    ExtraData ,
    EventType as TemplateId,
    UserId,
    Severity as SeverityId,
    1 as totalVolume ,
    InputType,
    ServiceStateId,
    Notify,
    EventSingleInstanceFlagRaised
insert into SMNGStreamStatuses;

--for each input in Topic_DA_CCTV move it to Topic_Enrich_In_Anyvision
@info(name='query_enrichment_anyvision')
from SMNGStream_CCTV_AsJSON [InputType == 'Event' and not(AdditionalInfo is null) and AdditionalInfo != '' and (EventSingleInstanceFlagRaised != true and TriggerStr != 'Unknown element arrived')] 
--#window.length(5)
select
    InputId,
    CreationDate,
    UserId,
    InputType,
    json:toObject(AdditionalInfo) as AdditionalInfoJsonObj
insert into SMNGStreamEnrichmentAnyvisionToJSON;

from SMNGStreamEnrichmentAnyvisionToJSON [json:isExists(AdditionalInfoJsonObj,'$.ProxyMessage') and json:isExists(AdditionalInfoJsonObj,'$.ProxyMessage.trap') and json:getString(AdditionalInfoJsonObj,'$.ProxyMessage.trap') == 'anyvision']
select
    InputId,
    CreationDate,
    UserId,
    InputType,
    AdditionalInfoJsonObj  as AdditionalInfo
insert into SMNGOutputStreamEnrichmentAnyvision;

--for each input in Topic_DA_CCTV move it to Topic_Enrich_In_Findface
@info(name='query_enrichment_findface')
from SMNGStream_CCTV_AsJSON [InputType == 'Event' and not(AdditionalInfo is null) and AdditionalInfo != '' and (EventSingleInstanceFlagRaised != true and TriggerStr != 'Unknown element arrived')] 
--#window.length(5)
select
    InputId,
    CreationDate,
    UserId,
    InputType,
    json:toObject(AdditionalInfo) as AdditionalInfoJsonObj
insert into SMNGStreamEnrichmentFindfaceToJSON;

from SMNGStreamEnrichmentFindfaceToJSON [json:isExists(AdditionalInfoJsonObj,'$.ProxyMessage') and json:isExists(AdditionalInfoJsonObj,'$.ProxyMessage.trap') and json:getString(AdditionalInfoJsonObj,'$.ProxyMessage.trap') == 'findface']
select
    InputId,
    CreationDate,
    UserId,
    InputType,
    AdditionalInfoJsonObj  as AdditionalInfo
insert into SMNGOutputStreamEnrichmentFindface;

